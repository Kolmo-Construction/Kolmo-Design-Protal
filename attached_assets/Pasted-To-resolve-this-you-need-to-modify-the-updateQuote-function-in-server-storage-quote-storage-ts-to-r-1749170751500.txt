To resolve this, you need to modify the updateQuote function in server/storage/quote-storage.ts to return the complete quote object, including the updated line items, after the database update is complete.

Here is the code change:

File: SecureUserPortal 2_clean/server/storage/quote-storage.ts

Original Code:

TypeScript

  async updateQuote(id: number, data: Partial<InsertCustomerQuote & { lineItems?: any[] }>): Promise<CustomerQuote | null> {
    // ... code to process and update the quote data ...

    const [quote] = await db
      .update(customerQuotes)
      .set(updateData)
      .where(eq(customerQuotes.id, id))
      .returning();

    // ... code to update line items ...

    return quote || null;
  }
Modified Code:

TypeScript

  async updateQuote(id: number, data: Partial<InsertCustomerQuote & { lineItems?: any[] }>): Promise<CustomerQuote | null> {
    // Extract line items from the data
    const { lineItems, ...quoteData } = data;
    
    // ... (existing data processing logic) ...

    // Update the quote
    const updateData = { ...processedData, updatedAt: new Date() };
    const [quote] = await db
      .update(customerQuotes)
      .set(updateData)
      .where(eq(customerQuotes.id, id))
      .returning();

    // Handle line items if provided
    if (lineItems && Array.isArray(lineItems)) {
      // Delete existing line items
      await db
        .delete(quoteLineItems)
        .where(eq(quoteLineItems.quoteId, id));

      // Insert new line items
      if (lineItems.length > 0) {
        const lineItemsToInsert = lineItems.map(item => ({
          quoteId: id,
          category: item.category || '',
          description: item.description || '',
          quantity: item.quantity || '1',
          unit: item.unit || '',
          unitPrice: item.unitPrice || '0',
          discountPercentage: item.discountPercentage || '0',
          totalPrice: item.totalPrice || '0'
        }));

        await db.insert(quoteLineItems).values(lineItemsToInsert);
      }
    }

    if (!quote) {
        return null;
    }

    // Fetch and return the full quote with the updated line items
    return this.getQuoteWithDetails(id);
  }
By changing the return value of the updateQuote function to this.getQuoteWithDetails(id), you ensure that the complete and up-to-date quote object, including the correctly updated line items, is sent back to the frontend. This will properly update the React Query cache, and you will see the correct values the next time you edit the quote.